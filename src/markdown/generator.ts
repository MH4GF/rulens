import fs from 'node:fs/promises'
import { parseBiomeRules } from '../parsers/biome-parser.ts'
import { parseESLintRules } from '../parsers/eslint-parser.ts'
import type { BiomeRageResult } from '../tools/biome-runner.ts'
import type { ESLintConfigResult } from '../tools/eslint-runner.ts'
import { lintRulesToMarkdown } from './lint-to-markdown.ts'

interface MarkdownGeneratorOptions {
  biomeResult: BiomeRageResult
  eslintResult: ESLintConfigResult
  outputFile: string
}

/**
 * ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’æ¨æ¸¬
 */
function guessProjectName(): string {
  try {
    // package.jsonã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å–å¾—ã™ã‚‹å®Ÿè£…ã‚‚å¯èƒ½ã ãŒã€
    // ç¾æ™‚ç‚¹ã§ã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã¯å›ºå®šã§è‰¯ã„
    return 'Project'
  } catch {
    return 'Project'
  }
}

/**
 * ç›®æ¬¡ã‚’ç”Ÿæˆ
 */
function generateTableOfContents(hasBiome: boolean, hasEslint: boolean): string {
  let toc = '## ğŸ“‘ Table of Contents\n\n'

  toc += '- [Introduction](#introduction)\n'
  toc += '- [AI Usage Guide](#ai-usage-guide)\n'

  if (hasBiome) {
    toc += '- [Biome Rules](#biome-rules)\n'
    // ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’å…¨ã¦åˆ—æŒ™ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã ãŒã€ã‚·ãƒ³ãƒ—ãƒ«ã«ã™ã‚‹
  }

  if (hasEslint) {
    toc += '- [ESLint Rules](#eslint-rules)\n'
    // ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’å…¨ã¦åˆ—æŒ™ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã ãŒã€ã‚·ãƒ³ãƒ—ãƒ«ã«ã™ã‚‹
  }

  return toc
}

/**
 * ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ç”Ÿæˆ
 */
function generateHeader(): string {
  const projectName = guessProjectName()
  return `# ${projectName} Lint Rules Reference\n\n## ğŸ“‹ Document Overview\n\nThis document contains a comprehensive catalog of linting rules enabled in this project. It is automatically generated by [Rulens](https://github.com/MH4GF/rulens) and provides AI code assistants and developers with detailed information about code style and quality requirements.\n\n`
}

/**
 * å°å…¥éƒ¨ã‚’ç”Ÿæˆ
 */
function generateIntroduction(): string {
  return (
    '## ğŸ“– Introduction\n\n' +
    'This document lists all active linting rules configured in the project. Each rule includes:\n\n' +
    '- A link to official documentation\n' +
    '- A brief description of what the rule enforces\n' +
    '- Severity level (when available)\n\n' +
    'Use this reference to understand the code standards and avoid common issues when writing or reviewing code.\n\n'
  )
}

/**
 * AIä½¿ç”¨ã‚¬ã‚¤ãƒ‰ã‚’ç”Ÿæˆ
 */
function generateAIUsageGuide(): string {
  return (
    '## ğŸ¤– AI Usage Guide\n\n' +
    '**For AI Code Assistants**: When generating code for this project, please adhere to the following guidelines:\n\n' +
    `1. **Scan relevant categories first**: Focus on rules in categories related to the code you're generating.\n` +
    '2. **Respect all rules**: Ensure all generated code follows all linting rules.\n' +
    '3. **Avoid common pitfalls**: Check complexity rules to avoid anti-patterns.\n\n' +
    'When uncertain about specific rules, refer to the rule documentation links provided.\n\n'
  )
}

export async function generateMarkdown(options: MarkdownGeneratorOptions): Promise<string> {
  const { biomeResult, eslintResult, outputFile } = options

  // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å„éƒ¨åˆ†ã‚’ç”Ÿæˆ
  let markdown = generateHeader()
  markdown += '---\n\n'

  // ç›®æ¬¡ã‚’è¿½åŠ 
  markdown += generateTableOfContents(!!biomeResult, !!eslintResult)
  markdown += '---\n\n'

  // å°å…¥éƒ¨ã¨AIä½¿ç”¨ã‚¬ã‚¤ãƒ‰ã‚’è¿½åŠ 
  markdown += generateIntroduction()
  markdown += '---\n\n'
  markdown += generateAIUsageGuide()
  markdown += '---\n\n'

  // 1. Biomeè¨­å®šã‚’å…±é€šä¸­é–“è¡¨ç¾ã«å¤‰æ›
  if (biomeResult) {
    const biomeLinter = parseBiomeRules(biomeResult)
    markdown += `${lintRulesToMarkdown(biomeLinter, true)}\n`
  }

  // 2. ESLintè¨­å®šã‚’å…±é€šä¸­é–“è¡¨ç¾ã«å¤‰æ›
  if (eslintResult) {
    const eslintLinter = parseESLintRules(eslintResult)
    markdown += lintRulesToMarkdown(eslintLinter, true)
  }

  // Write to file
  await fs.writeFile(outputFile, markdown, 'utf-8')

  return markdown
}
